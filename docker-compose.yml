services:
  relay:
    build:
      context: .
      target: relay
    ports:
      - "3001:3001"
    environment:
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - RELAY_PORT=${RELAY_PORT:-3001}
      - TRUSTED_PROXIES=${TRUSTED_PROXIES:-0}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=production
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
    restart: unless-stopped

  web:
    build:
      context: .
      target: web
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_RELAY_URL=${NEXT_PUBLIC_RELAY_URL:-ws://localhost:3001}
      - NODE_ENV=production
    depends_on:
      relay:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    restart: unless-stopped
